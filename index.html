<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Application plan — Navigation intérieure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b5fff" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="assets/icons/icon-180.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <!-- ✅ CHARGEMENT CORRECT DE LA FEUILLE DE STYLE -->
  <link rel="stylesheet" href="css/style.css" />
  <style>
  /* === OVERRIDE DEBUG POUR FORCER L'AFFICHAGE DU FOND === */
  #plan-image {
    /* le chemin est déjà bon côté CSS: ../assets/plan.png ; on force la taille visible */
    min-height: 70vh;            /* force une grande zone visible */
    height: calc(100vh - 180px); /* réglage pragmatique: plein écran moins l'en-tête */
    display: block;
    background-color: #fff;      /* pour voir la zone même sans image */
    outline: 1px dashed #aaa;    /* cadre de debug (tu pourras le retirer) */
    background-size: contain;    /* garde les proportions */
    background-repeat: no-repeat;
    background-position: top left;
  }

  /* On s'assure que le conteneur n'écrase pas la hauteur */
  #plan-container, #viewport {
    min-height: 70vh;
  }
  </style>
</head>
<body>
  <header>
    <h1>Navigation intérieure — bâtiment</h1>
    <div class="toolbar">
      <span id="modeBadge" class="mode-badge">Mode utilisation</span>
      <button id="toggleModeBtn">Basculer en mode édition</button>
      <div class="hint">Ouvrez ce fichier dans Firefox. Import auto de <code>data/plan_graph.json</code>.</div>
    </div>
  </header>

  <div class="app">
    <aside class="sidebar">
      <div class="card" id="route-panel">
        <h2>Itinéraire</h2>
        <div class="row">
          <label>Départ :</label>
          <select id="startSelect"></select>
        </div>
        <div class="row">
          <label>Arrivée :</label>
          <select id="endSelect"></select>
        </div>
        <div class="row">
          <button id="computeRoute">Calculer l’itinéraire</button>
        </div>
        <div id="routeDistance">Distance totale : —</div>
        <ol id="routeSteps"></ol>
      </div>

      <div class="card" id="scale-panel">
        <h2>Échelle (distances réelles)</h2>
        <div class="hint">Sélectionnez 2 points (Départ/Arrivée), entrez la distance, puis « Définir l’échelle ».</div>
        <div class="row">
          <input id="scaleDistance" type="number" min="0" step="0.01" placeholder="distance en mètres" />
          <button id="defineScaleBtn">Définir l’échelle</button>
        </div>
        <div id="scaleLabel">Échelle : —</div>
      </div>

      <div class="card" id="mode-panel">
        <h2>Édition</h2>
        <div class="hint">Ces actions sont actives uniquement en mode <b>Édition</b>.</div>
        <div class="row">
          <input id="poiName" type="text" placeholder="Nom du point" />
          <button id="deleteLastPoint">Supprimer dernier point</button>
        </div>
        <div class="row">
          <button id="toggleEdgeMode">Mode couloir</button>
          <button id="toggleDeleteEdgeMode">Suppression couloir</button>
          <button id="deleteLastEdge">Supprimer dernier couloir</button>
          <button id="clearAllEdges" class="danger">Supprimer tous les couloirs</button>
        </div>
        <div class="row">
          <button id="exportJson">Exporter JSON</button>
          <input id="importFile" type="file" accept=".json" />
          <button id="importBtn">Importer</button>
        </div>
      </div>
    </aside>

    <main class="stage-wrap">
      <div class="stage">
        <div id="plan-container">
          <div id="viewport">
            <div class="zoom-ui">
              <button id="zoomInBtn" title="Zoom avant (+)">+</button>
              <button id="zoomOutBtn" title="Zoom arrière (−)">−</button>
              <button id="zoomResetBtn" title="Réinitialiser (0)">⟲</button>
              <div class="label" id="zoomLabel">100%</div>
            </div>

            <!-- ✅ Conteneur commun pour l'image et le SVG -->
            <div id="camera">
              <div id="plan-image"></div>
              <svg id="scene">
assets/plan.png" x="0" y="0" width="100%" height="100%" preserveAspectRatio="none" />
                <g id="edges-layer"></g>
                <g id="path-layer"></g>
                <g id="points-layer"></g>
                <line id="edge-highlight" class="edge-hover" x1="0" y1="0" x2="0" y2="0" style="display:none;"></line>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- ✅ CHARGEMENT CORRECT DU SCRIPT -->
  <script src="js/app.js"></script>
  <script>
    // Test éclair : vérifie l'élément et calcule un ratio si besoin
    (function(){
      const el = document.getElementById('plan-image');
      if (!el) {
        console.error('plan-image introuvable (id exact attendu: "plan-image")');
        return;
      }
      const probe = new Image();
      probe.onload = function () {
        console.log('[DEBUG] plan.png dimensions:', probe.naturalWidth, 'x', probe.naturalHeight);
        if (probe.naturalWidth > 0 && probe.naturalHeight > 0) {
          // Si tu préfères un ratio proportionnel au plan, active le padding-top dynamique :
          // el.style.paddingTop = (probe.naturalHeight / probe.naturalWidth * 100) + '%';
          // et retire éventuellement height/min-height si tu veux piloter par ratio.
        }
      };
      probe.src = 'assets/plan.png';
    })();
  </script>

  <!-- ✅ Enregistrement du Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch(err => console.error('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
